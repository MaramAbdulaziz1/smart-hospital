<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Patient Prescription</title>
  <link rel="stylesheet" th:href="@{/css/sharedLayout.css}">
  <link rel="stylesheet" href="/css/prescription.css"/>
  <style>
    /* Âü∫Á°ÄÊ†∑Âºè */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }

    .layout-container {
      display: flex;
      min-height: 100vh;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .page-content {
      flex: 1;
      padding: 20px;
    }

    /* Â§ÑÊñπÂ∏ÉÂ±Ä */
    .prescription-layout {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .left-section, .right-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .left-section {
      flex: 1;
    }

    .right-section {
      flex: 2;
    }

    .fixed-section {
      margin-bottom: 25px;
    }

    .section-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #2c5282;
    }

    textarea, input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      box-sizing: border-box;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* ËçØÁâ©Âç°Áâá */
    .medication-card {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: #f8fafc;
    }

    .medication-card-header {
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
      color: #2c5282;
    }

    .medication-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    label {
      font-weight: 500;
      font-size: 14px;
    }

    /* ÊåâÈíÆÊ†∑Âºè */
    .button-bar {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px 12px;
      background: #edf2f7;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: #4a5568;
    }

    .action-btn:hover {
      background: #e2e8f0;
    }

    .floating-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .save-btn, .submit-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }

    .save-btn {
      background: #e2e8f0;
      color: #4a5568;
    }

    .save-btn:hover {
      background: #cbd5e0;
    }

    .submit-btn {
      background: #3182ce;
      color: white;
    }

    .submit-btn:hover {
      background: #2c5282;
    }

    /* Ê∂àÊÅØÊèêÁ§∫ */
    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .message-success {
      background: #10B981;
    }

    .message-error {
      background: #EF4444;
    }

    .message-warning {
      background: #F59E0B;
    }

    .message-info {
      background: #3B82F6;
    }

    /* Âä†ËΩΩÁä∂ÊÄÅ */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
  </style>
</head>
<body>
<div class="layout-container">
  <!-- Sidebar -->
  <aside th:replace="~{layouts/sharedLayout :: sidebar (activePage='prescription', appointmentId=${appointmentId})}"></aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Navigation -->
    <header th:replace="components/top-navD :: top-nav('Patient Prescription')"></header>
    <!-- Patient Info Card -->
    <section th:replace="components/patientCard :: patientCard(${appointmentId})"></section>

    <!-- Page-specific content -->
    <section class="page-content">
      <!-- Main Content -->
      <!-- Prescription Two Section -->
      <div class="prescription-layout">
        <!-- left -->
        <div class="left-section">
          <div class="fixed-section">
            <div class="section-title">Diagnosis</div>
            <textarea id="diagnosis" placeholder="Add diagnosis results..."></textarea>
          </div>

          <div class="fixed-section">
            <div class="section-title">Drug Allergy</div>
            <textarea id="drugAllergy" placeholder="Add drug allergy..."></textarea>
          </div>

          <div class="fixed-section">
            <div class="section-title">Medication Card Record</div>
            <select class="dropdown" id="medicationCardSelector">
              <option value="">Select Medication Card</option>
            </select>
          </div>
        </div>

        <!-- right -->
        <div class="right-section">
          <div class="medication-section">
            <div class="medication-card">
              <div class="medication-card-header" id="medicationCardHeader">Medication Card #1</div>

              <div class="medication-form">
                <!-- Medication Name -->
                <div class="form-group">
                  <label>Medication Name</label>
                  <input type="text" id="medicationName" placeholder="Add medicine name...">
                </div>

                <!-- Dosage and Frequency Row -->
                <div class="form-row">
                  <div class="form-group">
                    <label>Dosage</label>
                    <input type="text" id="dosage" placeholder="e.g., 500mg">
                  </div>
                  <div class="form-group">
                    <label>Frequency</label>
                    <input type="text" id="frequency" placeholder="e.g., Twice a day">
                  </div>
                </div>

                <!-- Note -->
                <div class="form-group">
                  <label>Note</label>
                  <textarea rows="3" id="note" placeholder="e.g., Take before meals"></textarea>
                </div>

                <!-- Route and Duration Row -->
                <div class="form-row">
                  <div class="form-group">
                    <label>Route</label>
                    <input type="text" id="route" placeholder="e.g., Oral or IV">
                  </div>
                  <div class="form-group">
                    <label>Duration</label>
                    <input type="text" id="duration" placeholder="e.g., For 7 days">
                  </div>
                </div>
              </div>
            </div>
            <div class="button-bar">
              <button class="action-btn" id="addCardBtn">
                <!-- ‚úö Add Card SVG -->
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 9V12M12 12V15M12 12H15M12 12H9M21 12C21 13.1819 20.7672 14.3522
                            20.3149 15.4442C19.8626 16.5361 19.1997 17.5282 18.364 18.364C17.5282
                            19.1997 16.5361 19.8626 15.4442 20.3149C14.3522 20.7672 13.1819 21 12
                            21C10.8181 21 9.64778 20.7672 8.55585 20.3149C7.46392 19.8626 6.47177
                            19.1997 5.63604 18.364C4.80031 17.5282 4.13738 16.5361 3.68508
                            15.4442C3.23279 14.3522 3 13.1819 3 12C3 9.61305 3.94821 7.32387
                            5.63604 5.63604C7.32387 3.94821 9.61305 3 12 3C14.3869 3 16.6761
                            3.94821 18.364 5.63604C20.0518 7.32387 21 9.61305 21 12Z"
                        stroke="#3F3F46" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Add Card
              </button>

              <button class="action-btn" id="deleteCardBtn">
                <!-- üóëÔ∏è Delete Card SVG -->
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 12H9M21 12C21 13.1819 20.7672 14.3522 20.3149 15.4442C19.8626
                            16.5361 19.1997 17.5282 18.364 18.364C17.5282 19.1997 16.5361 19.8626
                            15.4442 20.3149C14.3522 20.7672 13.1819 21 12 21C10.8181 21 9.64778
                            20.7672 8.55585 20.3149C7.46392 19.8626 6.47177 19.1997 5.63604
                            18.364C4.80031 17.5282 4.13738 16.5361 3.68508 15.4442C3.23279
                            14.3522 3 13.1819 3 12C3 9.61305 3.94821 7.32387 5.63604 5.63604C7.32387
                            3.94821 9.61305 3 12 3C14.3869 3 16.6761 3.94821 18.364 5.63604C20.0518
                            7.32387 21 9.61305 21 12Z"
                        stroke="#3F3F46" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Delete Card
              </button>
            </div>
            <div class="floating-buttons">
              <button class="save-btn" id="saveBtn">Save</button>
              <button class="submit-btn" id="submitBtn">Submit</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
<script th:src="@{/js/sharedLayout.js}"></script>
<script th:inline="javascript">
  class PrescriptionManager {
      constructor(appointmentId) {
          this.appointmentId = appointmentId;
          this.medicationCards = [];
          this.currentCardId = 1;
          this.currentCardData = {};
          this.isEditing = false;
          this.editingCardIndex = -1;
          this.init();
      }

      init() {
          this.bindEvents();
          this.updateCardHeader();
          this.updateDropdown();
          this.loadExternalData();
          this.setupDataSync();
      }

      bindEvents() {
          document.getElementById('addCardBtn').addEventListener('click', () => this.handleAddCard());
          document.getElementById('deleteCardBtn').addEventListener('click', () => this.handleDeleteCard());
          document.getElementById('saveBtn').addEventListener('click', () => this.handleSaveCurrentInput());
          document.getElementById('submitBtn').addEventListener('click', () => this.handleSubmitPrescription());
          document.getElementById('medicationCardSelector').addEventListener('change', (e) => this.handleCardSelection(e));
          this.bindFormInputs();
      }

      bindFormInputs() {
          const inputs = document.querySelectorAll('#medicationName, #dosage, #frequency, #note, #route, #duration');
          inputs.forEach(input => {
              input.addEventListener('input', (e) => this.handleInputChange(e));
          });
      }

      handleInputChange(event) {
          const input = event.target;
          const fieldName = input.id;

          this.currentCardData[fieldName] = input.value;
      }
      handleAddCard() {
          if (!this.validateCurrentCard()) {
              this.showMessage('Please fill in required medication information', 'error');
              return;
          }
          if (this.isEditing) {
              this.updateExistingCard();
          } else {
              this.addNewCard();
          }
          this.resetForm();
          this.updateDropdown();
          this.showMessage('Medication card added successfully', 'success');
      }

      addNewCard() {
          const newCard = {
              id: this.currentCardId,
              ...this.getCurrentFormData(),
              createdAt: new Date().toISOString()
          };

          this.medicationCards.push(newCard);
          this.currentCardId++;
      }

      updateExistingCard() {
          if (this.editingCardIndex >= 0) {
              this.medicationCards[this.editingCardIndex] = {
                  ...this.medicationCards[this.editingCardIndex],
                  ...this.getCurrentFormData(),
                  updatedAt: new Date().toISOString()
              };
          }
          this.isEditing = false;
          this.editingCardIndex = -1;
      }

      handleDeleteCard() {
          if (this.isEditing && this.editingCardIndex >= 0) {
              const cardToDelete = this.medicationCards[this.editingCardIndex];
              if (confirm(`Are you sure you want to delete Medication Card #${cardToDelete.id}?`)) {
                  this.medicationCards.splice(this.editingCardIndex, 1);
                  this.resetForm();
                  this.updateDropdown();
                  this.showMessage('Medication card deleted successfully', 'success');
                  this.isEditing = false;
                  this.editingCardIndex = -1;
              }
          } else {
              if (confirm('Are you sure you want to clear the current form?')) {
                  this.resetForm();
                  this.showMessage('Form cleared', 'info');
              }
          }
      }

      handleCardSelection(event) {
          const selectedValue = event.target.value;

          if (!selectedValue) {
              this.resetForm();
              return;
          }

          const cardId = parseInt(selectedValue);
          const cardIndex = this.medicationCards.findIndex(card => card.id === cardId);

          if (cardIndex >= 0) {
              this.loadCardForEditing(cardIndex);
          }
      }

      loadCardForEditing(cardIndex) {
          this.isEditing = true;
          this.editingCardIndex = cardIndex;
          const card = this.medicationCards[cardIndex];

          this.updateCardHeader(`Medication Card #${card.id} (Editing)`);
          this.populateForm(card);
          this.currentCardData = { ...card };
      }

      populateForm(cardData) {
          const fields = ['medicationName', 'dosage', 'frequency', 'note', 'route', 'duration'];
          fields.forEach(field => {
              const element = document.getElementById(field);
              if (element && cardData[field]) {
                  element.value = cardData[field];
              }
          });
      }

      getCurrentFormData() {
          return {
              medicationName: document.getElementById('medicationName').value || '',
              dosage: document.getElementById('dosage').value || '',
              frequency: document.getElementById('frequency').value || '',
              note: document.getElementById('note').value || '',
              route: document.getElementById('route').value || '',
              duration: document.getElementById('duration').value || ''
          };
      }

      validateCurrentCard() {
          const data = this.getCurrentFormData();
          return data.medicationName.trim() !== '' && data.dosage.trim() !== '';
      }
      resetForm() {
          const fields = ['medicationName', 'dosage', 'frequency', 'note', 'route', 'duration'];
          fields.forEach(field => {
              document.getElementById(field).value = '';
          });

          this.currentCardData = {};
          this.isEditing = false;
          this.editingCardIndex = -1;
          this.updateCardHeader();

          document.getElementById('medicationCardSelector').value = '';
      }

      updateCardHeader(title = null) {
          const header = document.getElementById('medicationCardHeader');
          if (header) {
              header.textContent = title || `Medication Card #${this.currentCardId}`;
          }
      }

      updateDropdown() {
          const dropdown = document.getElementById('medicationCardSelector');
          if (!dropdown) return;

          dropdown.innerHTML = '<option value="">Select Medication Card</option>';
          this.medicationCards.forEach(card => {
              const option = document.createElement('option');
              option.value = card.id;
              option.textContent = `Medication Card #${card.id} - ${card.medicationName}`;
              dropdown.appendChild(option);
          });
      }

      handleSaveCurrentInput() {

          this.currentCardData = this.getCurrentFormData();
          this.showMessage('Current input saved temporarily', 'info');
          const saveBtn = document.getElementById('saveBtn');
          if (saveBtn) {
              const originalStyle = saveBtn.style.backgroundColor;
              saveBtn.style.backgroundColor = '#e8f7fb';
              setTimeout(() => {
                  saveBtn.style.backgroundColor = originalStyle;
              }, 1000);
          }

          console.log('Current input saved:', this.currentCardData);
      }

      async handleSubmitPrescription() {
          if (this.medicationCards.length === 0) {
              this.showMessage('Please add at least one medication card before submitting', 'warning');
              return;
          }
          const prescriptionData = {
              appointmentId: this.appointmentId,
              diagnosis: document.getElementById('diagnosis').value || '',
              drugAllergy: document.getElementById('drugAllergy').value || '',
              medications: this.medicationCards.map(card => ({
                  name: card.medicationName,
                  dosage: card.dosage,
                  frequency: card.frequency,
                  note: card.note,
                  route: card.route,
                  duration: card.duration
              }))
          };

          this.showSubmissionProgress();

          try {
              const response = await this.submitToBackend(prescriptionData);
              if (response.code === '0'){
                  this.showMessage('Prescription submitted successfully!', 'success');
                  setTimeout(() => {
                      this.clearAllData();
                  }, 2000);
              } else {
                  this.showMessage(`Submission failed: ${response.message}`, 'error');
              }
          } catch (error) {
              console.error('Error submitting prescription:', error);
              this.showMessage('Failed to submit prescription. Please try again.', 'error');
          }
      }

      async submitToBackend(prescriptionData) {
          const response = await fetch('/prescription/add', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(prescriptionData)
          });

          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
      }

      showSubmissionProgress() {
          const submitBtn = document.getElementById('submitBtn');
          if (submitBtn) {
              const originalText = submitBtn.textContent;
              submitBtn.textContent = 'Submitting...';
              submitBtn.disabled = true;
              submitBtn.classList.add('loading');

              setTimeout(() => {
                  submitBtn.textContent = originalText;
                  submitBtn.disabled = false;
                  submitBtn.classList.remove('loading');
              }, 2000);
          }
      }

      showMessage(message, type = 'info') {
          const messageDiv = document.createElement('div');
          messageDiv.className = `message message-${type}`;
          messageDiv.textContent = message;

          const colors = {
              success: '#10B981',
              error: '#EF4444',
              warning: '#F59E0B',
              info: '#3B82F6'
          };
          messageDiv.style.backgroundColor = colors[type] || colors.info;
          document.body.appendChild(messageDiv);
          requestAnimationFrame(() => {
              messageDiv.style.opacity = '1';
          });
          setTimeout(() => {
              messageDiv.style.opacity = '0';
              setTimeout(() => {
                  if (messageDiv.parentNode) {
                      messageDiv.parentNode.removeChild(messageDiv);
                  }
              }, 300);
          }, 3000);
      }

      clearAllData() {
          if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
              this.medicationCards = [];
              this.currentCardId = 1;
              this.resetForm();
              document.getElementById('diagnosis').value = '';
              document.getElementById('drugAllergy').value = '';
              this.updateDropdown();
              this.showMessage('All data cleared successfully', 'success');
          }
      }

      loadExternalData() {
          const diagnosis = localStorage.getItem('clinicalNotes_diagnosis');
          const drugAllergy = localStorage.getItem('report_medicalHistory');
          if (diagnosis) {
              document.getElementById('diagnosis').value = diagnosis;
          }
          if (drugAllergy) {
              document.getElementById('drugAllergy').value = drugAllergy;
          }
          if (diagnosis || drugAllergy) {
              this.showMessage('Patient data synchronized successfully', 'success');
          }
      }

      setupDataSync() {
          window.addEventListener('storage', (e) => {
              if (e.key === 'clinicalNotes_diagnosis') {
                  document.getElementById('diagnosis').value = e.newValue || '';
              }

              if (e.key === 'report_medicalHistory') {
                  document.getElementById('drugAllergy').value = e.newValue || '';
              }
          });
      }
  }

  document.addEventListener('DOMContentLoaded', function() {
      const appointmentId = [[${appointmentId}]];
      window.prescriptionManager = new PrescriptionManager(appointmentId);
      console.log('Prescription system initialized with appointment ID:', appointmentId);
  });
</script>
</body>
</html>
