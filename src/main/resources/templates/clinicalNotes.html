<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clinical Notes</title>
  <link rel="stylesheet" th:href="@{/css/sharedLayout.css}">
  <link rel="stylesheet" href="/css/clinicalNotes.css"/>
</head>

<body>
<div class="layout-container">
  <!-- Sidebar -->
  <aside
    th:replace="~{layouts/sharedLayout :: sidebar (activePage='clinicalNotes', appointmentId=${appointmentId})}"></aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Navigation -->
    <header th:replace="components/top-navD :: top-nav('Clinical Notes')"></header>

    <!-- Patient Info Card -->
    <section th:replace="components/patientCard :: patientCard(${appointmentId})"></section>

    <section class="page-content">
      <!-- Intake Section -->
      <div class="form-column">
        <!-- Patient Complaint -->
        <div>
          <div class="tabs active">Patient Complaint</div>
          <textarea th:text="${patientComplaint}" class="intake-card complaint" disabled></textarea>
        </div>

        <!-- Notes Section -->
        <div class="form-row">
          <div>
            <!-- Tabs -->
            <div class="tab-container">
              <div class="tabs sub-tabs active" data-field="notes">Note</div>
              <div class="tabs sub-tabs" data-field="diagnosis">Diagnosis</div>
              <div class="tabs sub-tabs" data-field="medicalHistory">Medical History</div>
              <div class="tabs sub-tabs" data-field="followUpPlan">Follow-up Plan</div>
            </div>

            <!-- Textarea -->
            <textarea
              id="intakeTextarea"
              class="intake-card diagnosis"
              disabled
              placeholder='Click "Edit" to enter note...'>
                        </textarea>
          </div>

          <!-- Buttons -->
          <div class="button-group">
            <button class="edit-btn" onclick="enableEditing()">Edit</button>
            <button class="save-btn" onclick="saveCurrentField()">Save</button>
            <button class="submit-btn" onclick="submitAll()">Submit</button>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Hidden Fields to Hold Initial Data from Thymeleaf -->
<div id="intakeData"
     th:data-notes="${intake?.notes}"
     th:data-diagnosis="${intake?.diagnosis}"
     th:data-medical-history="${intake?.medicalHistory}"
     th:data-follow-up-plan="${intake?.followUpPlan}"
     th:data-appointment-id="${appointmentId}"
     style="display:none;">
</div>

<script>
  const clinicalNotes = {
      notes: document.getElementById('intakeData').getAttribute('data-notes') || '',
      diagnosis: document.getElementById('intakeData').getAttribute('data-diagnosis') || '',
      medicalHistory: document.getElementById('intakeData').getAttribute('data-medical-history') || '',
      followUpPlan: document.getElementById('intakeData').getAttribute('data-follow-up-plan') || '',
      currentField: 'notes'
  };

  const appointmentId = document.getElementById('intakeData').getAttribute('data-appointment-id');

  function initTextarea() {
      const textarea = document.getElementById('intakeTextarea');
      textarea.value = clinicalNotes[clinicalNotes.currentField];
      updatePlaceholder();
  }

  document.querySelectorAll('.sub-tabs').forEach(tab => {
      tab.addEventListener('click', () => {
          document.querySelectorAll('.sub-tabs').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const textarea = document.getElementById('intakeTextarea');
          clinicalNotes[clinicalNotes.currentField] = textarea.value;

          clinicalNotes.currentField = tab.getAttribute('data-field');
          textarea.value = clinicalNotes[clinicalNotes.currentField];
          updatePlaceholder();
      });
  });

  function updatePlaceholder() {
      const textarea = document.getElementById('intakeTextarea');
      const field = clinicalNotes.currentField;
      const placeholders = {
          'notes': 'Click "Edit" to enter note...',
          'diagnosis': 'Click "Edit" to enter diagnosis...',
          'medicalHistory': 'Click "Edit" to enter medical history...',
          'followUpPlan': 'Click "Edit" to enter follow-up plan...'
      };
      textarea.placeholder = placeholders[field];
  }

  function enableEditing() {
      const textarea = document.getElementById('intakeTextarea');
      textarea.removeAttribute('disabled');
      textarea.focus();
  }

  function saveCurrentField() {
      const textarea = document.getElementById('intakeTextarea');
      if (textarea.disabled) {
          showNotification('Please click "Edit" first to enable editing', 'warning');
          return;
      }

      const value = textarea.value.trim();
      if (!value) {
          showNotification('Cannot save empty content', 'warning');
          return;
      }

      clinicalNotes[clinicalNotes.currentField] = value;
      showNotification('Saved successfully!', 'success');
  }

  function submitAll() {
      const textarea = document.getElementById('intakeTextarea');
      if (textarea.disabled) {
          showNotification('Please edit and save content first', 'warning');
          return;
      }

      const data = {
          appointmentId: appointmentId,
          notes: clinicalNotes.notes,
          diagnosis: clinicalNotes.diagnosis,
          medicalHistory: clinicalNotes.medicalHistory,
          followUpPlan: clinicalNotes.followUpPlan
      };

      disableButtons(true);

      fetch('/intake/add', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
          if (result.code === "0") {
              showNotification('Submitted successfully!', 'success');
              setTimeout(() => {
                  location.reload();
              }, 1500);
          } else {
              throw new Error(result.message || 'Submission failed');
          }
      })
      .catch(err => {
          showNotification('Submit failed: ' + err.message, 'error');
          disableButtons(false);
      });
  }

  function disableButtons(disabled) {
      document.querySelectorAll('.save-btn, .submit-btn, .edit-btn').forEach(btn => {
          btn.disabled = disabled;
      });
      if (disabled) {
          document.querySelector('.submit-btn').textContent = 'Submitting...';
      } else {
          document.querySelector('.submit-btn').textContent = 'Submit';
      }
  }

  function showNotification(message, type) {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;

      // Set background color based on type
      let bgColor = '#4CAF50'; // success
      if (type === 'warning') bgColor = '#FF9800';
      if (type === 'error') bgColor = '#f44336';

      notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${bgColor};
          color: white;
          padding: 12px 20px;
          border-radius: 6px;
          z-index: 10000;
          font-size: 14px;
          opacity: 0;
          transform: translateX(100%);
          transition: all 0.3s ease;
          max-width: 300px;
          word-wrap: break-word;
      `;

      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
          notification.style.opacity = '1';
          notification.style.transform = 'translateX(0)';
      }, 10);

      // Remove after 3 seconds
      setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => {
              if (notification.parentNode) {
                  notification.parentNode.removeChild(notification);
              }
          }, 300);
      }, 3000);
  }
  document.addEventListener('DOMContentLoaded', function() {
      initTextarea();
  });
</script>

<!-- Scripts -->
<script th:src="@{/js/sharedLayout.js}"></script>
</body>
</html>
