<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Hospital</title>
  <link rel="stylesheet" th:href="@{/css/sharedLayout.css}">
  <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>
<body>

<div class="layout-container dashboard-page">
  <!-- Dashboard Sidebar -->
  <div th:replace="components/sidebarD :: sidebar('home')"></div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Top Navigation -->
    <header th:replace="components/top-navD :: top-nav('Smart Hospital')"></header>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      <div class="search-row">
        <input class="search1" type="text" id="searchInput" placeholder="Search by name or ID" />
        <button class="btn" id="searchBtn">Search</button>
      </div>
      <h3 class="section-title">Patient with appointments</h3>

      <div class="table-header">
        <div class="text">Patient</div>
        <div class="text">Date</div>
        <div class="text">Time</div>
        <div></div>
      </div>

      <div class="patient-table" id="patientTable">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading patient data...</p>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Scripts -->
<script th:src="@{/js/sharedLayout.js}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('searchInput');
      const searchBtn = document.getElementById('searchBtn');
      const patientTable = document.getElementById('patientTable');

      let allAppointments = [];

      // Fetch initial patient data
      fetchPatientData('/appointment/doctor/me', 'GET');

      // Function to fetch patient data
      function fetchPatientData(url, method, searchTerm = '') {
          showLoadingState();

          const requestOptions = {
              method: method,
              headers: {
                  'Content-Type': 'application/json'
              }
          };

          // Add search parameter if provided
          const finalUrl = searchTerm ? `${url}?search=${encodeURIComponent(searchTerm)}` : url;

          fetch(finalUrl, requestOptions)
              .then(response => {
                  if (!response.ok) {
                      throw new Error('Network response was not ok');
                  }
                  return response.json();
              })
              .then(data => {
                  if (data.code === "0") {
                      allAppointments = data.data;
                      renderPatientTable(allAppointments);
                  } else {
                      showErrorMessage('Failed to load patient data');
                  }
              })
              .catch(error => {
                  console.error('Error fetching patient data:', error);
                  showErrorMessage('Error loading patient data. Please try again.');
              });
      }

      // Function to render patient table
      function renderPatientTable(appointments) {
          patientTable.innerHTML = '';

          if (appointments.length === 0) {
              showNoResultsMessage();
              return;
          }

          appointments.forEach(appointment => {
              const row = document.createElement('div');
              row.className = 'patient-row';
              row.setAttribute('data-name', appointment.patientName);
              row.setAttribute('data-id', appointment.patientCode);

              row.innerHTML = `
                  <div>
                      <div class="default-text">${appointment.patientName}</div>
                      <span class="id">ID: ${appointment.patientCode}</span>
                  </div>
                  <div class="default-text">${formatDate(appointment.date)}</div>
                  <div class="default-text">${appointment.startTime || 'N/A'}</div>
                  <div class="button-group">
                      <a href="/patientProfile?appointmentId=${encodeURIComponent(appointment.appointmentId)}" class="btn filled">Profile</a>
                  </div>
              `;

              patientTable.appendChild(row);
          });
      }

      // Format date from YYYY-MM-DD to YYYY/MM/DD
      function formatDate(dateString) {
          return dateString.replace(/-/g, '/');
      }

      // Show loading state
      function showLoadingState() {
          patientTable.innerHTML = `
              <div class="loading-spinner">
                  <div class="spinner"></div>
                  <p>Loading patient data...</p>
              </div>
          `;
      }

      // Show error message
      function showErrorMessage(message) {
          patientTable.innerHTML = `
              <div class="error-message">
                  <p>${message}</p>
                  <button class="btn" onclick="location.reload()">Retry</button>
              </div>
          `;
      }

      // Show no results message
      function showNoResultsMessage() {
          patientTable.innerHTML = `
              <div class="no-results">
                  <div style="text-align: center; padding: 40px; color: #666;">
                      <div style="font-size: 18px; margin-bottom: 10px;">No patients found</div>
                      <div style="font-size: 14px;">Try searching with a different name or ID</div>
                  </div>
              </div>
          `;
      }

      // Search functionality
      function performSearch() {
          const searchTerm = searchInput.value.trim();

          if (searchTerm) {
              fetchPatientData('/appointment/search', 'GET', searchTerm);
          } else {
              fetchPatientData('/appointment/doctor/me', 'POST');
          }
      }

      // Event listeners
      searchBtn.addEventListener('click', performSearch);

      // Search on Enter key press
      searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
              performSearch();
          }
      });

      // Clear search when input is cleared
      searchInput.addEventListener('input', function() {
          if (this.value.trim() === '') {
              fetchPatientData('/appointment/doctor/me', 'POST');
          }
      });
  });
</script>

<style>
  .loading-spinner {
      text-align: center;
      padding: 40px;
  }

  .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6DA2B1;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
  }

  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }

  .error-message {
      text-align: center;
      padding: 40px;
      color: #d9534f;
  }

  .error-message button {
      margin-top: 15px;
  }
</style>

</body>
</html>
