<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Patient Vitals</title>
    <link rel="stylesheet" th:href="@{/css/sharedLayout.css}">
    <link rel="stylesheet" th:href="@{/css/vitals.css}">
</head>
<body>

<div class="layout-container">
  <!-- Sidebar -->
  <aside th:replace="~{layouts/sharedLayout :: sidebar (activePage='vitals')}"></aside>

  <!-- Main Content Area -->
  <main class="main-content">
    <!-- Top Navigation -->
    <header th:replace="components/top-navD :: top-nav('Patient Vitals')"></header>

    <!-- Patient Info Card -->
    <section th:replace="layouts/sharedLayout :: patientCard"></section>

    <!-- Vitals Content -->
    <section class="page-content">
        <!-- Vitals Form -->
        <form id="vitalsForm" class="vitals-form">
            <h2>Patient Vitals Record</h2>
            <div class="vitals-grid">
                <!-- First Row -->
                <div class="vital-group" data-unit="bpm">
                    <label for="heart-rate">
                        Heart Rate
                    </label>
                    <input type="number" step="0.1" min="0" max="300" id="heart-rate" name="heartRate" placeholder="e.g., 72 (beats per minute)">
                    <div class="help-text">Normal range: 60-100 bpm</div>
                </div>
                <div class="vital-group" data-unit="mmHg">
                    <label for="blood-pressure">
                        Blood Pressure
                    </label>
                    <input type="text" id="blood-pressure" name="bloodPressure" placeholder="e.g., 120/80 (systolic/diastolic)">
                    <div class="help-text">Format: systolic/diastolic (e.g., 120/80)</div>
                </div>
                <div class="vital-group" data-unit="°C">
                    <label for="temperature">
                        Temperature
                    </label>
                    <input type="number" step="0.1" min="30" max="45" id="temperature" name="temperature" placeholder="e.g., 37.2 (Celsius)">
                    <div class="help-text">Normal range: 36.1-37.2°C</div>
                </div>

                <!-- Second Row -->
                <div class="vital-group" data-unit="kg">
                    <label for="weight">Weight</label>
                    <input type="number" step="0.1" min="0" max="500" id="weight" name="weight" placeholder="e.g., 70.5 (kilograms)">
                    <div class="help-text">Enter weight in kilograms</div>
                </div>
                <div class="vital-group" data-unit="cm">
                    <label for="height">Height</label>
                    <input type="number" step="0.1" min="0" max="300" id="height" name="height" placeholder="e.g., 175 (centimeters)">
                    <div class="help-text">Enter height in centimeters</div>
                </div>
                <div class="vital-group" data-unit="kg/m²">
                    <label for="bmi">BMI</label>
                    <input type="number" step="0.1" min="0" max="100" id="bmi" name="bmi" placeholder="e.g., 23.1 (auto-calculated)">
                    <div class="help-text">Auto-calculated from weight and height</div>
                </div>

                <!-- Third Row -->
                <div class="vital-group" data-unit="mg/dl">
                    <label for="blood-glucose">Blood Glucose</label>
                    <input type="number" step="0.1" min="0" max="1000" id="blood-glucose" name="bloodGlucose" placeholder="e.g., 95 (mg/dL)">
                    <div class="help-text">Normal fasting: 70-100 mg/dL</div>
                </div>
                <div class="vital-group" data-unit="%">
                    <label for="oxygen-saturation">Blood Oxygen Saturation</label>
                    <input type="number" step="0.1" min="0" max="100" id="oxygen-saturation" name="oxygenSaturation" placeholder="e.g., 98 (percentage)">
                    <div class="help-text">Normal range: 95-100%</div>
                </div>
                <div class="vital-group" data-unit="breaths/min">
                    <label for="respiratory-rate">Respiratory Rate</label>
                    <input type="number" step="0.1" min="0" max="100" id="respiratory-rate" name="respiratoryRate" placeholder="e.g., 16 (breaths per minute)">
                    <div class="help-text">Normal range: 12-20 breaths/min</div>
                </div>
            </div>

            <!-- Form Footer -->
            <div class="form-footer">
                <div class="record-time">Recorded at: <span th:text="${currentTime}">15 July 2025, 12:35</span></div>
                <button type="submit" class="save-btn">Save</button>
            </div>
        </form>

        <!-- Vitals History -->
        <div class="vital-history">
            <div class="history-header">
                <h3>Vitals History (View All)</h3>
                <a href="/vitalsHistoryPage" class="view-all-btn">View All</a>
            </div>
            <table class="history-table">
              <!-- todo might need to link to backends -->
                <thead>
                    <tr>
                        <th>Date Of Visit</th>
                        <th>BP (mmHg)</th>
                        <th>HR (bpm)</th>
                        <th>Temp (°C)</th>
                        <th>Recorded By</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>10 Jul 2025</td>
                        <td>120/78</td>
                        <td>82</td>
                        <td>37.1</td>
                        <td>Dr. Sarah Moyo</td>
                    </tr>
                    <tr>
                        <td>18 Jun 2024</td>
                        <td>130/85</td>
                        <td>90</td>
                        <td>37.8</td>
                        <td>Dr. Samuel Chen</td>
                    </tr>
                    <tr>
                        <td>02 May 2024</td>
                        <td>118/75</td>
                        <td>76</td>
                        <td>36.9</td>
                        <td>Dr. Linda Patel</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
  </main>
</div>

<!-- Scripts -->
<script th:src="@{/js/sharedLayout.js}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const vitalsForm = document.getElementById('vitalsForm');
    const saveBtn = document.querySelector('.save-btn');

    // Form submission handler
    vitalsForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // Show loading state
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;

        // Get form data
        const formData = new FormData(vitalsForm);

        // Send to server
        fetch('/vitals/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(result => {
            if (result === 'success') {
                showNotification('Vitals saved successfully!', 'success');
                // Clear form after successful save
                vitalsForm.reset();
                // Update recorded time
                updateRecordedTime();
            } else {
                showNotification('Error saving vitals: ' + result, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error saving vitals. Please try again.', 'error');
        })
        .finally(() => {
            // Reset button state
            saveBtn.textContent = 'Save';
            saveBtn.disabled = false;
        });
    });

    // Auto-calculate BMI when weight or height changes
    const weightInput = document.getElementById('weight');
    const heightInput = document.getElementById('height');
    const bmiInput = document.getElementById('bmi');

    function calculateBMI() {
        const weight = parseFloat(weightInput.value);
        const height = parseFloat(heightInput.value);

        if (weight && height && height > 0) {
            const heightInMeters = height / 100; // Convert cm to meters
            const bmi = weight / (heightInMeters * heightInMeters);
            bmiInput.value = bmi.toFixed(1);
        }
    }

    weightInput.addEventListener('input', calculateBMI);
    heightInput.addEventListener('input', calculateBMI);

    // Blood pressure validation
    const bloodPressureInput = document.getElementById('blood-pressure');
    bloodPressureInput.addEventListener('input', function() {
        const value = this.value;
        // Allow format like "120/80" or "120/80 mmHg"
        const regex = /^\d{2,3}\/\d{2,3}(\s*mmHg)?$/;
        if (value && !regex.test(value)) {
            this.setCustomValidity('Please enter blood pressure in format: 120/80 (systolic/diastolic)');
        } else {
            this.setCustomValidity('');
        }
    });

    // Update recorded time
    function updateRecordedTime() {
        const now = new Date();
        const options = {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        const timeString = now.toLocaleDateString('en-US', options);
        document.querySelector('.record-time span').textContent = timeString;
    }

    // Show notification function
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#4CAF50' : '#f44336'};
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 10000;
            font-size: 14px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        `;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(0)';
        }, 10);

        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
});
</script>

</body>
</html>
