<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Patient Dashboard</title>

  <!-- CSS files -->
  <link rel="stylesheet" href="/css/patientdashboard.css"/>
  <!-- Web font: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Notification Styles -->
  <style>
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: none;
        font-size: 14px;
        font-weight: 500;
        animation: slideInRight 0.3s ease-out;
        min-width: 200px;
        text-align: center;
    }
    .notification.show { display: block; }
    .notification.success { background: #4CAF50; }
    .notification.error { background: #f44336; }
    .notification .close-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: none;
        border: none;
        color: white;
        font-size: 16px;
        cursor: pointer;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }
    .notification .close-btn:hover { background: rgba(255, 255, 255, 0.2); }
    @keyframes slideInRight {
        0% { transform: translateX(100%); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
    }
    .notification.hiding { animation: slideOutRight 0.3s ease-out forwards; }
    @keyframes slideOutRight {
        0% { transform: translateX(0); opacity: 1; }
        100% { transform: translateX(100%); opacity: 0; }
    }
    .btn.loading {
        position: relative;
        opacity: 0.7;
        pointer-events: none;
    }
    .btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Custom styles for the date picker */
    input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    /* Additional styles for the form elements */
    .form-row {
      margin-bottom: 15px;
    }

    .field {
      margin-bottom: 15px;
    }

    .label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    select, input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
<div class="layout-container">
  <!-- Patient Sidebar -->
  <aside class="sidebar">
    <img th:src="@{/SharedLayoutImages/LogoCircle.png}" alt="Logo" class="logo">
    <nav class="sidebar-nav">
      <div class="tab active-tab" data-page="home">
        <a href="/patient/patientDashboard">
          <img th:src="@{/SharedLayoutImages/homeIcon.svg}" alt="Home Icon" class="tab-icon">
          <span>Home</span>
        </a>
      </div>
      <div class="tab" data-page="calendar">
        <a th:href="@{/comingSoon}">
          <img th:src="@{/SharedLayoutImages/calendarIcon.svg}" alt="Calendar Icon" class="tab-icon">
          <span>Calendar</span>
        </a>
      </div>
      <div class="tab" data-page="health-qa">
        <a th:href="@{/comingSoon}">
          <img th:src="@{/PatientSideImages/healthQA.svg}" alt="Health Q&A Icon" class="tab-icon">
          <span>Health Q&A</span>
        </a>
      </div>
      <div class="tab" data-page="manage-appointments">
        <a href="/patient/manageAppointments">
          <img th:src="@{/PatientSideImages/ManageAppointment.svg}" alt="Manage Appointments Icon" class="tab-icon">
          <span>Manage Appointments</span>
        </a>
      </div>
    </nav>
    <div class="tab logout-tab" data-action="logout">
      <img th:src="@{/SharedLayoutImages/logoutIcon.svg}" alt="Logout Icon" class="tab-icon">
      <span>Log Out</span>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Navigation -->
    <header class="top-nav">
      <h1 class="page-title">Smart Hospital</h1>
      <div class="header-icons-container">
        <!-- Notifications -->
        <div class="notification-container">
          <img th:src="@{/SharedLayoutImages/notificationIcon.svg}" alt="Notifications" class="notification-icon" id="notificationIcon"/>
          <div class="notification-popup" id="notificationPopup">
            <div class="notification-header">
              <h3>Notifications</h3>
              <button class="close-btn" id="closeNotifications" aria-label="Close notifications">&times;</button>
            </div>
            <div class="notification-list">
              <div class="notification-item unread">
                <div class="notification-content">
                  <div class="notification-title">Your appointment is confirmed for tomorrow at 2:00 PM</div>
                  <div class="notification-time">5 minutes ago</div>
                </div>
                <div class="notification-dot"></div>
              </div>
              <div class="notification-item">
                <div class="notification-content">
                  <div class="notification-title">Prescription refill reminder</div>
                  <div class="notification-time">2 hours ago</div>
                </div>
              </div>
            </div>
            <div class="notification-footer">
              <button class="mark-all-read" type="button">Mark all as read</button>
              <button class="view-all" type="button">View all notifications</button>
            </div>
          </div>
        </div>
        <!-- Profile -->
        <div class="profile-container">
          <img id="profileAvatarSmall" th:src="@{/PatientProfile-PatientSide/patientProfilePic.png}" alt="Patient Profile" class="patient-profile"/>
          <div class="profile-popup" id="profilePopup">
            <div class="profile-header">
              <img id="profileAvatarLarge" th:src="@{/PatientProfile-PatientSide/patientProfilePic.png}" alt="Patient Profile" class="profile-avatar"/>
              <div class="profile-info">
                <h3 id="profileName">Harry Potter</h3>
                <p id="profilePatientId">Patient ID: HAT17653D</p>
              </div>
              <button class="close-btn" id="closeProfile" aria-label="Close profile">&times;</button>
            </div>
            <div class="profile-menu">
              <a th:href="@{/patientProfile-patientSide}" class="profile-menu-item" data-action="profile">
                <img th:src="@{/SharedLayoutImages/profileIcon.svg}" alt="Profile" class="menu-icon"/>
                <span>My Profile</span>
              </a>
              <div class="profile-divider"></div>
              <div class="profile-menu-item logout" data-action="logout">
                <img th:src="@{/PatientProfile-PatientSide/logoutIcon.svg}" alt="Logout" class="menu-icon"/>
                <span>Log Out</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Success Notification -->
    <div class="notification" id="notification">
      <span id="notificationMessage">Book Successfully!</span>
      <button class="close-btn" onclick="hideNotification()">&times;</button>
    </div>

    <!-- Page Content -->
    <section class="page-content">
      <!-- Upcoming Appointments -->
      <div class="page-heading">Upcoming Appointments</div>
      <section class="upcoming-wrap">
        <div class="upcoming-card">
          <div class="line-1">05 07 2025</div>
          <div class="line-2">10:00</div>
          <div class="line-3">Vital</div>
        </div>
        <div class="upcoming-card">
          <div class="line-1">07 07 2025</div>
          <div class="line-2">13:00</div>
          <div class="line-3">Dr. Weasley</div>
        </div>
      </section>

      <!-- Make Appointments -->
      <section class="panel">
        <h3>Make Appointments</h3>
        <form id="appointmentForm" onsubmit="handleDoctorAppointment(event)">
          <div class="form-grid">
            <div>
              <div class="form-row">
                <div class="field">
                  <label class="label">Department</label>
                  <select id="department" name="department" onchange="loadDoctors()" required>
                    <option value="">- Select Department -</option>
                  </select>
                </div>
                <div class="field">
                  <label class="label">Doctor</label>
                  <select id="doctor" name="doctor" onchange="loadAvailableDates()" required>
                    <option value="">- Please select a department first -</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="field">
                  <label class="label">Date</label>
                  <input type="date" id="appointmentDate" name="date" min="" onchange="loadAvailableTimes()" required />
                </div>
                <div class="field">
                  <label class="label">Time</label>
                  <select id="appointmentTime" name="time" required>
                    <option value="">- Select Time -</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="book-col">
              <button type="submit" class="btn">Book</button>
            </div>
          </div>
        </form>
      </section>

      <!-- Make Vital Appointments -->
      <section class="panel">
        <h3>Make Vital Appointments</h3>
        <form id="vitalAppointmentForm" onsubmit="handleVitalAppointment(event)">
          <div class="form-grid">
            <div>
              <div class="form-row">
                <div class="field">
                  <label class="label">Department</label>
                  <select id="vitalDepartment" name="department" onchange="loadNurses()" required>
                    <option value="">- Select Department -</option>
                  </select>
                </div>
                <div class="field">
                  <label class="label">Nurse</label>
                  <select id="nurse" name="nurse" onchange="loadVitalAvailableDates()" required>
                    <option value="">- Please select a department first -</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="field">
                  <label class="label">Date</label>
                  <input type="date" id="vitalDate" name="date" min="" onchange="loadVitalAvailableTimes()" required />
                </div>
                <div class="field">
                  <label class="label">Time</label>
                  <select id="vitalTime" name="time" required>
                    <option value="">- Select Time -</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="book-col">
              <button type="submit" class="btn">Book</button>
            </div>
          </div>
        </form>
      </section>
    </section>
  </main>
</div>

<!-- JavaScript -->
<script>
  let departments = [];
  let doctors = [];
  let nurses = [];
  let availableTimes = [];
  let vitalAvailableTimes = [];

  document.addEventListener('DOMContentLoaded', function () {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const minDate = tomorrow.toISOString().split('T')[0];
    document.getElementById('appointmentDate').setAttribute('min', minDate);
    document.getElementById('vitalDate').setAttribute('min', minDate);

    loadDepartments();

    fetchPatientProfile();
    // Notifications popup
    const notificationIcon = document.getElementById('notificationIcon');
    const notificationPopup = document.getElementById('notificationPopup');
    const closeNotifications = document.getElementById('closeNotifications');

    if (notificationIcon && notificationPopup) {
      notificationIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        notificationPopup.classList.toggle('show');
        const profilePopup = document.getElementById('profilePopup');
        if (profilePopup) profilePopup.classList.remove('show');
      });
      closeNotifications.addEventListener('click', () => notificationPopup.classList.remove('show'));
    }

    // Profile popup
    const patientProfileIcon = document.getElementById('profileAvatarSmall');
    const profilePopup = document.getElementById('profilePopup');
    const closeProfile = document.getElementById('closeProfile');

    if (patientProfileIcon && profilePopup) {
      patientProfileIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        profilePopup.classList.toggle('show');
        if (notificationPopup) notificationPopup.classList.remove('show');
      });
      closeProfile.addEventListener('click', () => profilePopup.classList.remove('show'));
    }

    // Close popups when clicking outside
    document.addEventListener('click', (e) => {
      if (notificationPopup && !notificationPopup.contains(e.target) && e.target !== notificationIcon) {
        notificationPopup.classList.remove('show');
      }
      if (profilePopup && !profilePopup.contains(e.target) && e.target !== patientProfileIcon) {
        profilePopup.classList.remove('show');
      }
    });

    // Mark all notifications as read
    const markAllReadBtn = document.querySelector('.mark-all-read');
    if (markAllReadBtn) {
      markAllReadBtn.addEventListener('click', () => {
        document.querySelectorAll('.notification-item.unread').forEach(item => {
          item.classList.remove('unread');
          const dot = item.querySelector('.notification-dot');
          if (dot) dot.remove();
        });
      });
    }

    // Logout functionality
    const logoutBtns = document.querySelectorAll('[data-action="logout"]');
    logoutBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        if (confirm('Are you sure you want to log out?')) {
          fetch('/user/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.code == '0')
              window.location.href = '/';
          })
          .catch(error => {
              console.error('Error:', error);
              alert('An error occurred during logout.');
          });
        }
      });
    });
  });

  async function fetchPatientProfile() {
    try {
      const response = await fetch('/profile/me/patient', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.code === '0') {
        updateProfileData(result.data);
      } else {
        console.error('Failed to fetch patient profile:', result.message);
        showNotification('Failed to load profile data', 'error');
      }
    } catch (error) {
      console.error('Error fetching patient profile:', error);
      showNotification('Error loading profile data', 'error');
    }
  }

  function updateProfileData(patientData) {
    if (patientData.avatarBase64) {
      document.getElementById('profileAvatarSmall').src = patientData.avatarBase64;
      document.getElementById('profileAvatarLarge').src = patientData.avatarBase64;
    }

    const fullName = `${patientData.firstName || ''} ${patientData.lastName || ''}`.trim();
    if (fullName) {
      document.getElementById('profileName').textContent = fullName;
    }

    if (patientData.patientCode) {
      document.getElementById('profilePatientId').textContent = `Patient ID: ${patientData.patientCode}`;
    }
  }

  function loadDepartments() {
    fetch('/data/department', {
      method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
      if (data.code === "0") {
        departments = data.data;
        const departmentSelect = document.getElementById('department');
        const vitalDepartmentSelect = document.getElementById('vitalDepartment');

        departmentSelect.innerHTML = '<option value="">- Select Department -</option>';
        vitalDepartmentSelect.innerHTML = '<option value="">- Select Department -</option>';

        departments.forEach(dept => {
          departmentSelect.innerHTML += `<option value="${dept.departmentCode}">${dept.departmentName}</option>`;
          vitalDepartmentSelect.innerHTML += `<option value="${dept.departmentCode}">${dept.departmentName}</option>`;
        });
      } else {
        throw new Error('Failed to load departments');
      }
    })
    .catch(error => {
      console.error('Error loading departments:', error);
      showNotification('Failed to load departments', 'error');
    });
  }

  function loadDoctors() {
    const departmentCode = document.getElementById('department').value;
    const doctorSelect = document.getElementById('doctor');

    if (departmentCode) {
      fetch(`/doctor/department?department=${departmentCode}`, {
        method: 'GET'
      })
      .then(response => response.json())
      .then(data => {
        if (data.code === "0") {
          doctors = data.data;
          doctorSelect.innerHTML = '<option value="">- Select Doctor -</option>';
          doctors.forEach(doctor => {
            doctorSelect.innerHTML += `<option value="${doctor.providerId}">${doctor.fullName}</option>`;
          });
        } else {
          throw new Error('Failed to load doctors');
        }
      })
      .catch(error => {
        console.error('Error loading doctors:', error);
        doctorSelect.innerHTML = '<option value="">Failed to load doctors</option>';
        showNotification('Failed to load doctors', 'error');
      });
    } else {
      doctorSelect.innerHTML = '<option value="">- Please select a department first -</option>';
    }
  }

  function loadNurses() {
    const departmentCode = document.getElementById('vitalDepartment').value;
    const nurseSelect = document.getElementById('nurse');

    if (departmentCode) {
      fetch(`/nurse/department?department=${departmentCode}`, {
        method: 'GET'
      })
      .then(response => response.json())
      .then(data => {
        if (data.code === "0") {
          nurses = data.data;
          nurseSelect.innerHTML = '<option value="">- Select Nurse -</option>';
          nurses.forEach(nurse => {
            nurseSelect.innerHTML += `<option value="${nurse.providerId}">${nurse.fullName}</option>`;
          });
        } else {
          throw new Error('Failed to load nurses');
        }
      })
      .catch(error => {
        console.error('Error loading nurses:', error);
        nurseSelect.innerHTML = '<option value="">Failed to load nurses</option>';
        showNotification('Failed to load nurses', 'error');
      });
    } else {
      nurseSelect.innerHTML = '<option value="">- Please select a department first -</option>';
    }
  }

  function loadAvailableTimes() {
    const doctorId = document.getElementById('doctor').value;
    const date = document.getElementById('appointmentDate').value;
    const timeSelect = document.getElementById('appointmentTime');

    if (doctorId && date) {
      fetch(`/doctor/appointment?doctorId=${doctorId}&date=${date}`, {
        method: 'GET'
      })
      .then(response => response.json())
      .then(data => {
        if (data.code === "0") {
          availableTimes = data.data;
          timeSelect.innerHTML = '<option value="">- Select Time -</option>';
          availableTimes.forEach(time => {
            timeSelect.innerHTML += `<option value="${time.timeCode}">${time.startTime}</option>`;
          });
        } else {
          throw new Error('Failed to load available times');
        }
      })
      .catch(error => {
        console.error('Error loading available times:', error);
        timeSelect.innerHTML = '<option value="">Failed to load available times</option>';
        showNotification('Failed to load available times', 'error');
      });
    }
  }

  function loadVitalAvailableTimes() {
    const nurseId = document.getElementById('nurse').value;
    const date = document.getElementById('vitalDate').value;
    const timeSelect = document.getElementById('vitalTime');

    if (nurseId && date) {
      fetch(`/nurse/appointment?nurseId=${nurseId}&date=${date}`, {
        method: 'GET'
      })
      .then(response => response.json())
      .then(data => {
        if (data.code === "0") {
          vitalAvailableTimes = data.data;
          timeSelect.innerHTML = '<option value="">- Select Time -</option>';
          vitalAvailableTimes.forEach(time => {
            timeSelect.innerHTML += `<option value="${time.timeCode}">${time.startTime}</option>`;
          });
        } else {
          throw new Error('Failed to load available times');
        }
      })
      .catch(error => {
        console.error('Error loading available times:', error);
        timeSelect.innerHTML = '<option value="">Failed to load available times</option>';
        showNotification('Failed to load available times', 'error');
      });
    }
  }

  function handleDoctorAppointment(event) {
    event.preventDefault();

    const doctorId = document.getElementById('doctor').value;
    const date = document.getElementById('appointmentDate').value;
    const timeCode = document.getElementById('appointmentTime').value;
    const submitBtn = event.target.querySelector('button[type="submit"]');

    submitBtn.classList.add('loading');
    submitBtn.disabled = true;

    const requestBody = {
      date: date,
      time: parseInt(timeCode),
      type: 1,
      providerId: doctorId
    };

    fetch('/appointment/book', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
      if (data.code === "0") {
        showNotification('Appointment Booked Successfully!', 'success');
        resetForm('appointmentForm');
      } else {
        throw new Error(data.message || 'Booking failed');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Booking failed: ' + error.message, 'error');
    })
    .finally(() => {
      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
    });
  }

  function handleVitalAppointment(event) {
    event.preventDefault();

    const nurseId = document.getElementById('nurse').value;
    const date = document.getElementById('vitalDate').value;
    const timeCode = document.getElementById('vitalTime').value;
    const submitBtn = event.target.querySelector('button[type="submit"]');

    submitBtn.classList.add('loading');
    submitBtn.disabled = true;

    const requestBody = {
      date: date,
      time: parseInt(timeCode),
      type: 2,
      providerId: nurseId
    };

    fetch('/appointment/book', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
      if (data.code === "0") {
        showNotification('Vital Appointment Booked Successfully!', 'success');
        resetForm('vitalAppointmentForm');
      } else {
        throw new Error(data.message || 'Booking failed');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Booking failed: ' + error.message, 'error');
    })
    .finally(() => {
      submitBtn.classList.remove('loading');
      submitBtn.disabled = false;
    });
  }

  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const messageElement = document.getElementById('notificationMessage');

    messageElement.textContent = message;
    notification.className = `notification ${type} show`;

    setTimeout(() => {
      hideNotification();
    }, 3000);
  }

  function hideNotification() {
    const notification = document.getElementById('notification');
    notification.classList.add('hiding');

    setTimeout(() => {
      notification.classList.remove('show', 'hiding');
    }, 300);
  }

  function resetForm(formId) {
    const form = document.getElementById(formId);
    form.reset();

    const doctorSelect = document.getElementById('doctor');
    const nurseSelect = document.getElementById('nurse');
    const timeSelect = formId === 'appointmentForm' ?
      document.getElementById('appointmentTime') :
      document.getElementById('vitalTime');

    if (doctorSelect) {
      doctorSelect.innerHTML = '<option value="">- Please select a department first -</option>';
    }
    if (nurseSelect) {
      nurseSelect.innerHTML = '<option value="">- Please select a department first -</option>';
    }
    if (timeSelect) {
      timeSelect.innerHTML = '<option value="">- Select Time -</option>';
    }
  }

  function loadAvailableDates() {
  }

  function loadVitalAvailableDates() {
  }
</script>
</body>
</html>
